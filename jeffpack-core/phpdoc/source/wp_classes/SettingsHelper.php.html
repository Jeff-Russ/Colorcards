<html>
    <head>
        <script
            type="text/javascript"
            src="../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * SettingsHelper helps maintain a plugin options page as well as access options 
 * values in your WordPress Plugin. It makes heavy use of the PersistArgs class 
 * which it extends. 
 * 
 * @package     JeffPack
 * @subpackage  WordPress Classes
 * @access      public
 * @author      Jeff Russ
 * @copyright   2016 Jeff Russ
 * @license     GPL-2.0
 */
if ( ! class_exists('SettingsHelper')) {
	/**
	 * SettingsHelper class is a collection of methods to help maintain a plugin 
	 * options page as well as access options values in your WordPress Plugin. 
	 * It makes heavy use of the PersistArgs class which it extends. 
	 * 
	 * Most options are chainable, using  the variable data from the previous call 
	 * in the next. For example, you call
	 * 
	 * $plug-&gt;addSettingsPage()-&gt;addSettingsSection()-&gt;addSetting(&quot;Your Name&quot;);
	 * 
	 * The section is added to the page you just made, not some previously made one, 
	 * and the setting is added to the section you just made. Even if you don't chain
	 * the above would work since it's in logical order but if it's not the last 
	 * argument is passed by reference and written to for future use in what would 
	 * be the next logical method call. For example: 
	 * 
	 * $plug-&gt;addSettingsPage('menu' &quot;on sidebar&quot;, null, $menu_def_section);
	 * $plug-&gt;addSettingsPage('options' &quot;in tools&quot;, null, $tools_def_section);
	 * 
	 * $menu_my_section = $menu_def_section;
	 * 
	 * $plug-&gt;addSettingsSection('my section', $menu_my_section);
	 * 
	 * $plug-&gt;addSetting('setting1', '', '', $menu_def_section );
	 * $plug-&gt;addSetting('setting2', '', '', $menu_my_section );
	 * $plug-&gt;addSetting('setting3', '', '', $tools_def_section);
	 * 
	 */
	class SettingsHelper extends PluginData { # extends PersistArgs extends HelperModule

		/**
		* Calls add_menu_page(), add_options_page(), or add_submenu_page() with a built in
		* Closure that calls settings_fields(), do_settings_sections() submit_button()
		*
		* @param  string $menu_location &quot;menu&quot; calls add_menu_page, 
		* &quot;options&quot; calls add_options_page anything else calls add_submenu_page 
		* and is passed as first arg
		* @param  string $page_title first arg sent to 
		* add_options_page/add_submenu_page or second arg send to add_submenu_page
		* @param  string $menu_title second arg sent to 
		* add_options_page/add_submenu_page or third arg send to add_submenu_page
		* @param  array  $args can have 'icon_url' or 'position' elements added 
		* and after call will have page and default section info added. 
		* @return $this  returns reference to object to enable method call chaining
		* @access public
		*/
		public function addSettingsPage (
			$menu_location=&quot;menu&quot;, $page_title=null, $menu_title=null, &amp;$args=null
		) {
			if ($page_title === null) $page_title = $this-&gt;info['plugin_name'];
			if ($menu_title === null) $menu_title = $page_title;
			if ($args === null) $args = array();
			$icon_url = $this-&gt;getPassedArg($args, 'icon_url');
			$position = $this-&gt;getPassedArg($args, 'position');

			switch ($menu_location) {
				case &quot;menu&quot;:
					$page_slug = $this-&gt;info['plugin_prefix'].'_menu'; break;
				case &quot;options&quot;:
					$page_slug = $this-&gt;info['plugin_prefix'].'_settings'; break;
				default:
					$snake_loc = $this-&gt;toSnakeCase($menu_location);
					$snake_title = $this-&gt;toSnakeCase($menu_title);
					$page_slug = $this-&gt;info['plugin_prefix']
						. &quot;_${snake_loc}_${snake_title}&quot;;
			}
			$this-&gt;info['settings_pages'][$page_slug] = array(
				'menu_location' =&gt; $menu_location,
				'page_title' =&gt; $page_title,
				'menu_title' =&gt; $menu_title,
				'page_slug' =&gt; $page_slug,
				'icon_url' =&gt; $icon_url,
				'position' =&gt; $position,
				'option_group' =&gt; $page_slug.'_option_group',
				'option_name' =&gt; $page_slug.'_option_name',
				'sections' =&gt; array( $page_slug.'_default_section' )
			);
			$this-&gt;info['settings_sections'][$page_slug.'_default_section'] = array(
				'page_slug' =&gt; $page_slug,
				'section_id' =&gt; $page_slug.'_default_section',
				'section_title' =&gt; '', # no title!
				'option_group' =&gt; $page_slug.'_option_group',
				'option_name' =&gt; $page_slug.'_option_name',
				'indented' =&gt; false,
				'settings' =&gt; array(),
			);
			$args = $this-&gt;mergeArgs(
				$this-&gt;info['settings_pages'][$page_slug],
				$this-&gt;info['settings_sections'][$page_slug.'_default_section']
			);

			add_action(&quot;admin_menu&quot;, function() use ($args) { extract($args);
				
				if ($menu_location === 'menu'):
					add_menu_page( # add_menu_page adds page directly on the sidebar:
					$page_title, $menu_title, &quot;manage_options&quot;, $page_slug, function() use ($args) {
						extract($args);
						?&gt;&lt;div class=&quot;wrap&quot;&gt;
							&lt;h1&gt;&lt;?php echo $page_title; ?&gt;&lt;/h1&gt;
							&lt;hr color='#333' size='4'&gt;
							&lt;form action=&quot;options.php&quot; method=&quot;post&quot;&gt; &lt;?php
								settings_fields( $option_group );
								do_settings_sections( $page_slug );
								submit_button();
							?&gt;&lt;form&gt;
						&lt;/div&gt;&lt;?php
					}, $icon_url, $position);

				elseif ($menu_location === 'options'):
					add_options_page( # add menu under &quot;Settings&quot;
					$page_title, $menu_title, &quot;manage_options&quot;, $page_slug, function() use ($args) {
						extract($args);
						?&gt;&lt;div class=&quot;wrap&quot;&gt;
							&lt;h1&gt;&lt;?php echo $page_title; ?&gt;&lt;/h1&gt;
							&lt;hr color='#333' size='4'&gt;
							&lt;form action=&quot;options.php&quot; method=&quot;post&quot;&gt; &lt;?php
								settings_fields( $option_group );
								do_settings_sections( $page_slug );
								submit_button();
							?&gt;&lt;form&gt;
						&lt;/div&gt;&lt;?php
					}, $icon_url, $position);

				else:
					add_submenu_page( $menu_location, # add submenu under $menu_location
					$page_title, $menu_title, &quot;manage_options&quot;, $page_slug, function() use ($args) {
						extract($args);
						?&gt;&lt;div class=&quot;wrap&quot;&gt;
							&lt;h1&gt;&lt;?php echo $page_title; ?&gt;&lt;/h1&gt;
							&lt;hr color='#333' size='4'&gt;
							&lt;form action=&quot;options.php&quot; method=&quot;post&quot;&gt; &lt;?php
								settings_fields( $option_group );
								do_settings_sections( $page_slug );
								submit_button();
							?&gt;&lt;form&gt;
						&lt;/div&gt;&lt;?php
					}, $icon_url, $position);
				endif;
			});

			add_action( &quot;admin_init&quot;, function() use ($args){
				extract($args);
				register_setting( $option_group, $option_name ); 
				add_settings_section( $section_id, &quot;&quot;, function(){}, $page_slug );
			});

			return $this;
		}

		/**
		* Calls add_action(&quot;admin_init&quot;,function(){add_settings_section(...function(){...});
		*
		* @param  string $section_title (optional, defaulting to '') 
		* @param  array  $args if provided should have 'page_slug'. after call it will have 
		* section info added. 
		* @return $this  returns reference to object to enable method call chaining
		* @access public
		*/
		public function addSettingsSection($section_title='', &amp;$args=null)
		{
			if ($args === null) $args = array();
			$page_slug = $this-&gt;getArg($args, 'page_slug');
			$section_id = $page_slug . '_' . $this-&gt;toSnakeCase($section_title);

			array_push( $this-&gt;info['settings_pages'][$page_slug]['sections'], $section_id );

			$this-&gt;info['settings_sections'][$section_id] = array (
				'section_title' =&gt; $section_title,
				'page_slug' =&gt; $page_slug,
				'section_id' =&gt; $section_id,
				'option_group' =&gt; $this-&gt;getArg($args, 'option_group'),
				'option_name' =&gt; $this-&gt;getArg($args, 'option_name'),
				'indented' =&gt; $this-&gt;getPassedArg($args, 'indented', true),
				'settings'=&gt; array(),
			);

			$args = $this-&gt;mergeArgs($this-&gt;info['settings_sections'][$section_id] );

			if ($use['indented']):
				add_action( &quot;admin_init&quot;, function() use ($args) { extract($args);
					add_settings_section( $section_id, $section_title,
					function(){echo'&lt;div style=&quot;margin-left:8%&quot;&gt;';}, $page_slug );

					add_settings_section('/'.$section_id,'', # dummy section to close div
					function(){echo&quot;&lt;/div&gt;\r\n&quot;;}, $page_slug ); 
				});
			else:
				add_action( &quot;admin_init&quot;, function() use ($args) { extract($args);
					add_settings_section( $section_id, $section_title, function(){
					/* $section_title WILL be displayed! */}, $page_slug );
				});
			endif;

			$this-&gt;args = array_merge($this-&gt;args, $args);
			return $this;
		}

		/**
		* Calls add_action(&quot;admin_init&quot;,function(){add_settings_section(...function(){...});
		*
		* @param  string $setting_label
		* @param  mixed $default is the default value the setting should have
		* @param  mixed $source if provided should be a string of html or a callback.
		* If not provided, a text field will be created. 
		* If you provide a string use single quotes and embed $name and $value.
		* If you use a callback, do function($args) { extract($args); ...}
		* @param  array  $args if provided should have 'page_slug' and section info. 
		* after call it will have setting info added. 
		* @return $this  returns reference to object to enable method call chaining
		* @access public
		*/
		public function addSetting($setting_label, $default='', $source='', &amp;$args=null)
		{
			if ($args === null) $args = array();
			$section_id = $this-&gt;getArg($args, 'section_id');
			$setting_id = &quot;${section_id}_&quot; . $this-&gt;toSnakeCase($setting_label);

			$section_info = $this-&gt;info['settings_sections'][$section_id];
			array_push( $this-&gt;info['settings_sections'][$section_id]['settings'], $setting_id );

			if ( empty($source) ) $source = '&lt;input type=&quot;text&quot; name=&quot;$name&quot; value=&quot;$value&quot;&gt;';

			$this-&gt;info['settings'][$setting_id] = array (
				'setting_id' =&gt; $setting_id,
				'setting_label' =&gt; $setting_label,
				'name' =&gt; $section_info['option_name'].&quot;[${setting_id}]&quot;,
				'source' =&gt; $source,
				'default' =&gt; $default,
				'page_slug' =&gt; $section_info['page_slug'],
				'section_id' =&gt; $section_info['section_id'],
				'section_title' =&gt; $section_info['section_title'],
				'option_group' =&gt; $section_info['option_group'],
				'option_name' =&gt; $section_info['option_name'],
				'indented' =&gt; $section_info['indented'],
			);
			# getSetting below cant be called until the array above is set.
			$this-&gt;info['settings'][$setting_id]['value'] = $this-&gt;getSetting($setting_id);

			$args = $this-&gt;mergeArgs($args, $this-&gt;info['settings'][$setting_id]);

			if ( is_callable($source) ):
				add_action( &quot;admin_init&quot;, function() use($args) { extract($args);
					add_settings_field(
						$setting_id, $setting_label, $source, $page_slug, $section_id, $args);
				});
			else:
				add_action( &quot;admin_init&quot;, function() use($args) { extract($args);
					add_settings_field( $setting_id, $setting_label, function() use($args) {
						extract($args);
						$source = str_replace('$name', $name, $source);
						$source = str_replace('$value', $value, $source);
						echo $source;
					}, $page_slug, $section_id );
				});
			endif;
			return $this;
		}
		/**
		* public function getSetting($setting_id)
		* {
		* 	extract( $this-&gt;info['settings'][$setting_id] );
		* 	$options = wp_parse_args(get_option($option_name), [$setting_id =&gt; $default] );
		* 	return $options[$setting_id];
		* }
		*
		* @param  string $setting_id 
		* @return mixed  returns value of setting
		* @access public
		*/
		public function getSetting($setting_id)
		{
			extract( $this-&gt;info['settings'][$setting_id] );
			$options = wp_parse_args(get_option($option_name), [$setting_id =&gt; $default] );
			return $options[$setting_id];
		}

		#==========================================================================

		// private function getSettingsInfo($arg, $key='page_slug', $this_info='')
		// {
		// 	if ( empty($this_info) ) $this_info = $this-&gt;info['settings_pages'];

		// 	if (is_string($arg)):
		// 		return $arg;
		// 	elseif ( is_array($arg) ):
		// 		return $arg[$key];
		// 	elseif (empty($arg) ):
		// 		# if they don't specify we'll assume last created
		// 		return end( $this_info )[$key];
		// 	endif;
		// }
	}
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>